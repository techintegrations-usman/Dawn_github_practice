{% if settings.show_bundle_product %}
  {% assign products = settings.product_list %}
  <div class="cart-bundle-products">
    {% if settings.cart_drawer_heading != blank %}
      <h2 class="heading">{{ settings.cart_drawer_heading }}</h2>
    {% endif %}
    <div class="bundle-products-row">
      {% for product in products limit: 3 %}
        <div class="bundle-products">
          <div class="img">
            <img src="{{ product.featured_image | img_url: '100x' }}">
          </div>
          <div class="info">
            <h2>{{ product.title }}</h2>
            <p>{{ product.price | money }}</p>
          </div>
          <div class="atc">
            <form action="/cart/add" method="POST" enctype="multipart/form-data">
              <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
              <button type="submit" class="button small-btn">Add</button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}
<script>
       const addToCartFormsScript = document.querySelectorAll('form[action="/cart/add"]');
  addToCartFormsScript.forEach((form) => {
      let formSubmitted = false;

      const onSubmit = async (event) => {
          event.preventDefault();
          event.stopPropagation();

          // Check if the form has already been submitted
          if (formSubmitted) {
              return;
          }

          try {
              const formData = new FormData(form);
              const xhr = new XMLHttpRequest();

              xhr.open("POST", "{{ '/cart/add' | url }}", true);
              xhr.onreadystatechange = function () {
                  if (xhr.readyState === 4) {
                      if (xhr.status === 200) {
                          // Log the entire HTML response to the console
                          console.log(xhr.responseText);

                          const html = document.createElement("div");
                          html.innerHTML = xhr.responseText;

                          // Check if .cart-drawer element exists
                          const cartDrawerElement = html.querySelector(".cart-drawer");
                          if (cartDrawerElement) {
                              const newBox = cartDrawerElement.innerHTML;
                              document.querySelector(".cart-drawer").innerHTML = newBox;

                              // Clear the form after successful submission
                              form.reset();

                              // Set the flag to true after successful submission
                              formSubmitted = true;
                          } else {
                              console.error("Failed to find .cart-drawer element in the response");
                          }
                      } else {
                          console.error("Failed to add product to the cart");
                      }
                  }
              };

              xhr.send(formData);
          } catch (error) {
              console.error("An error occurred:", error);
          }
      };

      form.addEventListener("submit", onSubmit);
  });
</script>
